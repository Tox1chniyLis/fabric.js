{"version":3,"file":"LayoutStrategy.mjs","sources":["../../../../src/LayoutManager/LayoutStrategies/LayoutStrategy.ts"],"sourcesContent":["import { Point } from '../../Point';\nimport type { FabricObject } from '../../shapes/Object/FabricObject';\nimport { makeBoundingBoxFromPoints } from '../../util/misc/boundingBoxFromPoints';\nimport {\n  LAYOUT_TYPE_INITIALIZATION,\n  LAYOUT_TYPE_IMPERATIVE,\n} from '../constants';\nimport type {\n  InitializationLayoutContext,\n  LayoutStrategyResult,\n  StrictLayoutContext,\n} from '../types';\nimport { getObjectBounds } from './utils';\n\n/**\n * Exposes a main public method {@link calcLayoutResult} that is used by the `LayoutManager` to perform layout.\n * Returning `undefined` signals the `LayoutManager` to skip the layout.\n *\n * In charge of calculating the bounding box of the passed objects.\n */\nexport abstract class LayoutStrategy {\n  /**\n   * override by subclass for persistence (TS does not support `static abstract`)\n   */\n  static type = 'strategy';\n\n  /**\n   * Used by the `LayoutManager` to perform layout\n   * @TODO/fix: if this method is calcResult, should calc unconditionally.\n   * the condition to not calc should be evaluated by the layoutManager.\n   * @returns layout result **OR** `undefined` to skip layout\n   */\n  public calcLayoutResult(\n    context: StrictLayoutContext,\n    objects: FabricObject[],\n  ): LayoutStrategyResult | undefined {\n    if (this.shouldPerformLayout(context)) {\n      return this.calcBoundingBox(objects, context);\n    }\n  }\n\n  shouldPerformLayout({ type, prevStrategy, strategy }: StrictLayoutContext) {\n    return (\n      type === LAYOUT_TYPE_INITIALIZATION ||\n      type === LAYOUT_TYPE_IMPERATIVE ||\n      (!!prevStrategy && strategy !== prevStrategy)\n    );\n  }\n\n  shouldLayoutClipPath({ type, target: { clipPath } }: StrictLayoutContext) {\n    return (\n      type !== LAYOUT_TYPE_INITIALIZATION &&\n      clipPath &&\n      !clipPath.absolutePositioned\n    );\n  }\n\n  getInitialSize(\n    context: StrictLayoutContext & InitializationLayoutContext,\n    result: Pick<LayoutStrategyResult, 'center' | 'size'>,\n  ) {\n    return result.size;\n  }\n\n  /**\n   * Override this method to customize layout.\n   */\n  calcBoundingBox(\n    objects: FabricObject[],\n    context: StrictLayoutContext,\n  ): LayoutStrategyResult | undefined {\n    const { type, target } = context;\n    if (type === LAYOUT_TYPE_IMPERATIVE && context.overrides) {\n      return context.overrides;\n    }\n    if (objects.length === 0) {\n      return;\n    }\n    const { left, top, width, height } = makeBoundingBoxFromPoints(\n      objects\n        .map((object) => getObjectBounds(target, object))\n        .reduce<Point[]>((coords, curr) => coords.concat(curr), []),\n    );\n    const bboxSize = new Point(width, height);\n    const bboxLeftTop = new Point(left, top);\n    const bboxCenter = bboxLeftTop.add(bboxSize.scalarDivide(2));\n\n    if (type === LAYOUT_TYPE_INITIALIZATION) {\n      const actualSize = this.getInitialSize(context, {\n        size: bboxSize,\n        center: bboxCenter,\n      });\n      return {\n        // in `initialization` we do not account for target's transformation matrix\n        center: bboxCenter,\n        // TODO: investigate if this is still necessary\n        relativeCorrection: new Point(0, 0),\n        size: actualSize,\n      };\n    } else {\n      //  we send `relativeCenter` up to group's containing plane\n      const center = bboxCenter.transform(target.calcOwnMatrix());\n      return {\n        center,\n        size: bboxSize,\n      };\n    }\n  }\n}\n"],"names":["LayoutStrategy","calcLayoutResult","context","objects","shouldPerformLayout","calcBoundingBox","_ref","type","prevStrategy","strategy","LAYOUT_TYPE_INITIALIZATION","LAYOUT_TYPE_IMPERATIVE","shouldLayoutClipPath","_ref2","target","clipPath","absolutePositioned","getInitialSize","result","size","overrides","length","left","top","width","height","makeBoundingBoxFromPoints","map","object","getObjectBounds","reduce","coords","curr","concat","bboxSize","Point","bboxLeftTop","bboxCenter","add","scalarDivide","actualSize","center","relativeCorrection","transform","calcOwnMatrix","_defineProperty"],"mappings":"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"}